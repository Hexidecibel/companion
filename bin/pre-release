#!/bin/bash
# pre-release — Verify everything passes before tagging a release.
#
# Mirrors CI checks exactly so there are no surprises in GitHub Actions.
# Run this before creating a version tag.
#
# Usage:
#   bin/pre-release           # Check current state
#   bin/pre-release v0.3.0    # Check + verify versions match the tag
#
# Prerequisites: node, npm
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT="$(dirname "$SCRIPT_DIR")"
TAG="${1:-}"
FAILED=0
WARNINGS=0

red()    { printf '\033[1;31m%s\033[0m\n' "$*"; }
green()  { printf '\033[1;32m%s\033[0m\n' "$*"; }
yellow() { printf '\033[1;33m%s\033[0m\n' "$*"; }
blue()   { printf '\033[1;34m%s\033[0m\n' "$*"; }

step() { blue "=== $1 ==="; }
pass() { green "  PASS: $1"; }
fail() { red   "  FAIL: $1"; FAILED=1; }
warn() { yellow "  WARN: $1"; WARNINGS=$((WARNINGS+1)); }

# Force devDependencies install (NODE_ENV=production skips them)
export NODE_ENV=development

# ── 1. Git status ──────────────────────────────────────────────
step "Git Status"
if [ -n "$(git -C "$ROOT" status --porcelain)" ]; then
  warn "Uncommitted changes detected (commit or stash before tagging)"
  git -C "$ROOT" status --short
else
  pass "Working tree clean"
fi

# ── 2. Version consistency ─────────────────────────────────────
step "Version Consistency"

DAEMON_VER=$(node -p "require('$ROOT/daemon/package.json').version")
WEB_VER=$(node -p "require('$ROOT/web/package.json').version")
DESKTOP_VER=$(node -p "require('$ROOT/desktop/package.json').version")
TAURI_VER=$(node -p "require('$ROOT/desktop/src-tauri/tauri.conf.json').version")

echo "  daemon/package.json:             $DAEMON_VER"
echo "  web/package.json:                $WEB_VER"
echo "  desktop/package.json:            $DESKTOP_VER"
echo "  desktop/src-tauri/tauri.conf.json: $TAURI_VER"

if [ "$DAEMON_VER" = "$WEB_VER" ] && [ "$WEB_VER" = "$DESKTOP_VER" ] && [ "$DESKTOP_VER" = "$TAURI_VER" ]; then
  pass "All versions match: $DAEMON_VER"
else
  fail "Version mismatch across packages"
fi

if [ -n "$TAG" ]; then
  EXPECTED="${TAG#v}"
  if [ "$DAEMON_VER" = "$EXPECTED" ]; then
    pass "Versions match tag $TAG"
  else
    fail "Versions ($DAEMON_VER) don't match tag $TAG (expected $EXPECTED)"
  fi
fi

# ── 3. Clean install (lockfile drift check) ────────────────────
step "Daemon: npm ci"
cd "$ROOT/daemon" && npm ci 2>&1 | tail -1 && pass "npm ci" || fail "npm ci"

step "Web: npm ci"
cd "$ROOT/web" && npm ci 2>&1 | tail -1 && pass "npm ci" || fail "npm ci"

# ── 4. Daemon checks (matches CI exactly) ──────────────────────
step "Daemon: Typecheck"
cd "$ROOT/daemon" && npm run typecheck 2>&1 && pass "typecheck" || fail "typecheck"

step "Daemon: Lint"
cd "$ROOT/daemon" && npm run lint 2>&1 && pass "lint" || fail "lint"

step "Daemon: Format Check"
cd "$ROOT/daemon" && npm run format:check 2>&1 && pass "format:check" || fail "format:check"

step "Daemon: Tests"
TEST_OUTPUT=$(cd "$ROOT/daemon" && npm test 2>&1) || true
echo "$TEST_OUTPUT" | tail -20
# Jest forceExit can return non-zero even when all tests pass (open handles).
# Check actual test results instead of exit code.
if echo "$TEST_OUTPUT" | grep -q "Tests:.*failed"; then
  fail "tests — some tests failed"
elif echo "$TEST_OUTPUT" | grep -q "Tests:.*passed"; then
  pass "tests (all passed)"
else
  fail "tests — could not determine results"
fi

step "Daemon: Build"
cd "$ROOT/daemon" && npm run build 2>&1 && pass "build" || fail "build"

# ── 5. Web checks (matches CI exactly) ─────────────────────────
step "Web: Typecheck"
cd "$ROOT/web" && npx tsc --noEmit 2>&1 && pass "typecheck" || fail "typecheck"

step "Web: Build"
cd "$ROOT/web" && npm run build 2>&1 && pass "build" || fail "build"

# ── 6. Summary ─────────────────────────────────────────────────
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if [ $FAILED -eq 0 ] && [ $WARNINGS -eq 0 ]; then
  green "READY TO RELEASE"
  if [ -n "$TAG" ]; then
    echo "  Tag with: git tag $TAG && git push origin $TAG"
  else
    echo "  Tag with: git tag v$DAEMON_VER && git push origin v$DAEMON_VER"
  fi
elif [ $FAILED -eq 0 ]; then
  yellow "CHECKS PASSED with $WARNINGS warning(s) — review before tagging"
else
  red "NOT READY — fix failures above before tagging"
  exit 1
fi
