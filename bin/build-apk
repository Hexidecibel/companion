#!/bin/bash
# build-apk — Build, sign, and optionally install Android APK via Tauri.
#
# Usage:
#   bin/build-apk
#
# Prerequisites: node, npm, cargo, Android SDK, Java 17+
# The keystore at desktop/debug.keystore is used for signing.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT="$(dirname "$SCRIPT_DIR")"
DESKTOP="$ROOT/desktop"
KEYSTORE="$DESKTOP/debug.keystore"
OUTPUT="/tmp/companion-tauri.apk"

# Check prerequisites
if [ ! -d "$DESKTOP/src-tauri/gen/android" ]; then
  echo "Android project not initialized. Running init + setup..."
  cd "$DESKTOP"
  npx tauri android init
  bash scripts/setup-android.sh
fi

echo "=== Building Android APK ==="
cd "$DESKTOP" && cargo tauri android build --target aarch64

# Find the unsigned APK
UNSIGNED=$(find "$DESKTOP/src-tauri/gen/android/app/build/outputs/apk" -name '*.apk' | head -1)
if [ -z "$UNSIGNED" ]; then
  echo "ERROR: No APK found after build"
  exit 1
fi

# Sign
if [ -f "$KEYSTORE" ]; then
  echo ""
  echo "=== Signing APK ==="
  APKSIGNER=$(find "$ANDROID_HOME/build-tools" -name apksigner -type f | sort -V | tail -1 2>/dev/null || echo "apksigner")
  "$APKSIGNER" sign --ks "$KEYSTORE" --ks-pass pass:android --key-pass pass:android --out "$OUTPUT" "$UNSIGNED"
  echo "Signed APK: $OUTPUT"
else
  cp "$UNSIGNED" "$OUTPUT"
  echo "WARNING: No keystore found at $KEYSTORE — APK is unsigned"
  echo "APK: $OUTPUT"
fi

# Install if ADB is available and device connected
if command -v adb &>/dev/null && adb devices | grep -q "device$"; then
  echo ""
  echo "=== Installing to device ==="
  adb install -r "$OUTPUT"
  echo "Installed!"
else
  echo ""
  echo "No ADB device connected. Install manually:"
  echo "  adb install -r $OUTPUT"
fi
