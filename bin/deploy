#!/bin/bash
# Build daemon + web, restart the daemon service
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT="$(dirname "$SCRIPT_DIR")"

echo "=== Building Web Client ==="
cd "$ROOT/web" && npm run build

echo ""
echo "=== Building Daemon ==="
cd "$ROOT/daemon" && npm run build

echo ""
echo "=== Restarting Daemon ==="
if systemctl --user is-active companion &>/dev/null; then
  systemctl --user restart companion
  echo "Daemon restarted (user service)"
elif command -v systemctl &>/dev/null && systemctl is-active companion &>/dev/null; then
  sudo systemctl restart companion
  echo "Daemon restarted (system service)"
elif [[ "$OSTYPE" == "darwin"* ]]; then
  launchctl kickstart -k "gui/$(id -u)/com.companion.daemon" 2>/dev/null || true
  echo "Daemon restarted (launchd)"
else
  echo "WARNING: Could not detect service manager. Restart manually."
fi

echo ""
echo "=== Deploy complete ==="
systemctl --user status companion --no-pager 2>/dev/null || true
