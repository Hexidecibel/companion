#!/bin/bash
# deploy â€” Build daemon + web client, then restart the daemon service.
#
# Usage:
#   bin/deploy
#
# Prerequisites: node, npm
# Requires a running daemon service (see: bin/companion autostart enable)
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT="$(dirname "$SCRIPT_DIR")"

if ! command -v node &>/dev/null; then
  echo "ERROR: Node.js is not installed. See https://nodejs.org/" >&2
  exit 1
fi

if [ ! -f "$ROOT/.companion/config.json" ] && [ ! -f "$HOME/.companion/config.json" ]; then
  echo "TIP: No config found. Run 'bin/companion setup' first." >&2
fi

echo "=== Building Web Client ==="
cd "$ROOT/web" && npm run build

echo ""
echo "=== Building Daemon ==="
cd "$ROOT/daemon" && npm run build

echo ""
echo "=== Restarting Daemon ==="
if systemctl --user is-active companion &>/dev/null; then
  systemctl --user restart companion
  echo "Daemon restarted (user service)"
elif command -v systemctl &>/dev/null && systemctl is-active companion &>/dev/null; then
  sudo systemctl restart companion
  echo "Daemon restarted (system service)"
elif [[ "$OSTYPE" == "darwin"* ]]; then
  launchctl kickstart -k "gui/$(id -u)/com.companion.daemon" 2>/dev/null || true
  echo "Daemon restarted (launchd)"
else
  echo "WARNING: Could not detect service manager. Restart manually."
fi

echo ""
echo "=== Deploy complete ==="
systemctl --user status companion --no-pager 2>/dev/null || true
