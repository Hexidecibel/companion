#!/bin/bash
# test â€” Run all tests, lint, and type checks (daemon + web).
#
# Usage:
#   bin/test
#
# Prerequisites: node, npm
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT="$(dirname "$SCRIPT_DIR")"

if ! command -v node &>/dev/null; then
  echo "ERROR: Node.js is not installed. See https://nodejs.org/" >&2
  exit 1
fi
FAILED=0

echo "=== Daemon: Typecheck ==="
cd "$ROOT/daemon" && npm run typecheck || FAILED=1

echo ""
echo "=== Daemon: Lint ==="
cd "$ROOT/daemon" && npm run lint || FAILED=1

echo ""
echo "=== Daemon: Format Check ==="
cd "$ROOT/daemon" && npm run format:check || FAILED=1

echo ""
echo "=== Daemon: Tests ==="
cd "$ROOT/daemon" && npm test || FAILED=1

echo ""
echo "=== Web: Typecheck ==="
cd "$ROOT/web" && npx tsc --noEmit || FAILED=1

echo ""
echo "=== Web: Build ==="
cd "$ROOT/web" && npm run build || FAILED=1

echo ""
if [ $FAILED -eq 0 ]; then
  echo "=== All checks passed ==="
else
  echo "=== Some checks FAILED ==="
  exit 1
fi
